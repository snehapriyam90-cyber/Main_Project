{% extends "admin_dashboard.html" %}

{% block content %}
<div class="container-fluid py-4">

    <h3 class="fw-bold text-success mb-4">Sales & Reports</h3>

    <div class="row g-4">

        <!-- ORDER STATUS CHART -->
        <div class="col-lg-6 col-md-12">
            <div class="card shadow-sm border-0 rounded-4 p-3 h-100">
                <div class="card-header bg-success text-white rounded-3 mb-3">
                    <h5 class="mb-0">Order Status Overview</h5>
                </div>
                <div class="card-body">
                    <canvas id="statusChart" style="height:320px;"></canvas>
                </div>
            </div>
        </div>

        <!-- TOP PRODUCT SALES TABLE -->
        <div class="col-lg-6 col-md-12">
            <div class="card shadow-sm border-0 rounded-4 p-3 h-100">
                <div class="card-header bg-primary text-white rounded-3 mb-3">
                    <h5 class="mb-0">Top Product Sales</h5>
                </div>
                <div class="card-body p-0">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Sl No</th>
                                <th>Product</th>
                                <th>Total Sold</th>
                                <th>Revenue (₹)</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for product in top_products %}
                            <tr>
                                <td>{{ forloop.counter }}</td>
                                <td>{{ product.name }}</td>
                                <td>{{ product.quantity }}</td>
                                <td>₹ {{ product.revenue|floatformat:2 }}</td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="4" class="text-center text-muted">No product sales yet.</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- FARMER SALES CHART -->
        <div class="col-lg-6 col-md-12">
            <div class="card shadow-sm border-0 rounded-4 p-3 h-100">
                <div class="card-header bg-warning text-dark rounded-3 mb-3">
                    <h5 class="mb-0">Top Farmer Earnings</h5>
                </div>
                <div class="card-body">
                    <canvas id="farmerChart" style="height:320px;"></canvas>
                </div>
            </div>
        </div>

        <!-- TOTAL SUMMARY CARDS -->
        <div class="col-lg-6 col-md-12">
            <div class="row g-3">
                <div class="col-6">
                    <div class="card shadow-sm border-0 rounded-4 p-3 text-center h-100 bg-light">
                        <h6>Total Orders</h6>
                        <p class="display-6 text-primary">{{ total_orders }}</p>
                    </div>
                </div>
                <div class="col-6">
                    <div class="card shadow-sm border-0 rounded-4 p-3 text-center h-100 bg-light">
                        <h6>Total Quantity</h6>
                        <p class="display-6 text-success">{{ total_quantity }}</p>
                    </div>
                </div>
                <div class="col-12">
                    <div class="card shadow-sm border-0 rounded-4 p-3 text-center h-100 bg-light">
                        <h6>Total Earnings</h6>
                        <p class="display-6 text-warning">₹ {{ total_earnings|floatformat:2 }}</p>
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

{{ status_labels|json_script:"status-labels" }}
{{ status_counts|json_script:"status-counts" }}
{{ farmer_labels|json_script:"farmer-labels" }}
{{ farmer_values|json_script:"farmer-values" }}

<script>
document.addEventListener("DOMContentLoaded", function() {

    const statusLabels = JSON.parse(document.getElementById('status-labels').textContent);
    const statusCounts = JSON.parse(document.getElementById('status-counts').textContent);

    const farmerLabels = JSON.parse(document.getElementById('farmer-labels').textContent);
    const farmerValues = JSON.parse(document.getElementById('farmer-values').textContent);

    // ---------- Order Status Pie Chart ----------
    if (statusLabels.length) {
        new Chart(document.getElementById('statusChart'), {
            type: 'pie',
            data: {
                labels: statusLabels.map(s => s.charAt(0).toUpperCase() + s.slice(1)),
                datasets: [{
                    data: statusCounts,
                    backgroundColor: ['#198754', '#0d6efd', '#ffc107', '#dc3545', '#6c757d'],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'bottom', labels: { padding: 15, boxWidth: 20 } },
                    tooltip: { callbacks: { label: ctx => `${ctx.label}: ${ctx.raw}` } }
                }
            }
        });
    }

    // ---------- Top Farmer Earnings (Horizontal Bar) ----------
    if (farmerLabels.length) {
        new Chart(document.getElementById('farmerChart'), {
            type: 'bar',
            data: {
                labels: farmerLabels,
                datasets: [{
                    label: 'Earnings (₹)',
                    data: farmerValues,
                    backgroundColor: '#198754',
                    borderRadius: 8
                }]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: { beginAtZero: true, ticks: { callback: value => '₹' + value } }
                },
                plugins: { legend: { display: false }, tooltip: { callbacks: { label: ctx => '₹ ' + ctx.raw } } }
            }
        });
    }

});
</script>
{% endblock %}
{% endblock %}
