{% extends "farmer_dashboard.html" %}
{% block content %}

<div class="container py-5">

    <!-- BACK -->
    <a href="{% url 'farmer_orders' %}"
       class="btn btn-outline-success mb-4 rounded-pill px-3 py-2">
        <i class="bi bi-arrow-left"></i> Back to Orders
    </a>

    <!-- TITLE -->
    <h4 class="fw-bold text-success mb-4">
        Update Order Status – #{{ order.id }}
    </h4>

    <div class="row g-4">

        <!-- LEFT -->
        <div class="col-lg-8">

            <!-- ORDER INFO -->
            <div class="card shadow-sm rounded-4 mb-4 border-0">
                <div class="card-body">
                    <h5 class="fw-bold text-primary mb-3">Order Details</h5>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <p class="mb-1 fw-semibold">Customer</p>
                            <p class="text-muted">{{ order.customer.username }}</p>
                        </div>

                        <div class="col-md-6">
                            <p class="mb-1 fw-semibold">Payment Method</p>
                            <p class="text-muted">{{ order.get_payment_method_display }}</p>
                        </div>
                    </div>

                    <p class="mb-1 fw-semibold">Delivery Address</p>
                    <p class="text-muted">{{ order.address }}</p>
                </div>
            </div>

            <!-- FARMER PRODUCTS -->
            <div class="card shadow-sm rounded-4 border-0">
                <div class="card-body">

                    <h5 class="fw-bold text-primary mb-3">
                        Your Products in this Order
                    </h5>

                    {% for item in items %}
                    <div class="d-flex justify-content-between align-items-center p-3 mb-3 border rounded-3">

                        <div class="d-flex align-items-center gap-3">
                            {% if item.product.image %}
                                <img src="{{ item.product.image.url }}"
                                     width="70" height="70"
                                     class="rounded-3"
                                     style="object-fit:cover;">
                            {% else %}
                                <img src="https://via.placeholder.com/70"
                                     class="rounded-3">
                            {% endif %}

                            <div>
                                <h6 class="fw-semibold mb-1">
                                    {{ item.product.name }}
                                </h6>

                                <small class="text-muted">
                                    Ordered Qty: {{ item.quantity }}
                                </small><br>

                                <small class="text-muted">
                                    Bundle Size: {{ item.product.quantity }}
                                </small><br>

                                <small class="text-muted">
                                    Bundle Price: ₹ {{ item.price }}
                                </small>
                            </div>
                        </div>

                        <div class="text-end">
                            <span class="badge 
                                {% if item.status == 'pending' %}bg-warning text-dark
                                {% elif item.status == 'processing' %}bg-primary
                                {% elif item.status == 'shipped' %}bg-info text-dark
                                {% elif item.status == 'delivered' %}bg-success
                                {% elif item.status == 'cancelled' %}bg-danger
                                {% endif %}">
                                {{ item.status|title }}
                            </span>

                            <p class="fw-bold text-success mt-2 mb-0">
                                ₹ {{ item.subtotal }}
                            </p>
                        </div>

                    </div>
                    {% empty %}
                        <p class="text-muted">No products from you in this order.</p>
                    {% endfor %}

                    <hr>

                    <!-- TOTALS -->
                    <div class="d-flex justify-content-between mb-2">
                        <span class="fw-semibold">Subtotal</span>
                        <span>₹ {{ farmer_subtotal }}</span>
                    </div>

                    <div class="d-flex justify-content-between mb-2">
                        <span class="fw-semibold">Delivery Charge</span>
                        <span>₹ {{ delivery_charge }}</span>
                    </div>

                    {% if cod_charge > 0 %}
                    <div class="d-flex justify-content-between mb-2">
                        <span class="fw-semibold">COD Charge</span>
                        <span>₹ {{ cod_charge }}</span>
                    </div>
                    {% endif %}

                    <hr>

                    <div class="d-flex justify-content-between fs-5 fw-bold">
                        <span>Total Amount</span>
                        <span class="text-success">
                            ₹ {{ farmer_total }}
                        </span>
                    </div>

                </div>
            </div>

        </div>

        <!-- RIGHT -->
        <div class="col-lg-4">

            <form method="POST"
                  class="card shadow-sm rounded-4 border-0 position-sticky"
                  style="top:120px;">
                {% csrf_token %}

                <div class="card-body">

                    <h5 class="fw-bold text-primary mb-3">
                        Update Order Status
                    </h5>

                    <select name="status"
                            class="form-select form-select-lg mb-4">
                        {% for key, value in status_choices %}
                        <option value="{{ key }}"
                            {% if items.first.status == key %}selected{% endif %}>
                            {{ value }}
                        </option>
                        {% endfor %}
                    </select>

                    <button type="submit"
                            class="btn btn-success btn-lg w-100 rounded-pill fw-semibold">
                        Update Status
                    </button>

                </div>
            </form>

        </div>

    </div>
</div>

<style>
.card {
    transition: 0.3s ease;
}
.card:hover {
    transform: translateY(-4px);
    box-shadow: 0 16px 30px rgba(0,0,0,0.12);
}
</style>

{% endblock %}
