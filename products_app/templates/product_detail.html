{% extends "customer_dashboard.html" %}
{% load static %}
{% block content %}

<div class="container py-4">

    <!-- BACK BUTTON -->
    <a href="{% url 'product_list' %}" class="btn btn-secondary mb-3">
        <i class="bi bi-arrow-left"></i> Back
    </a>

    <div class="row">

        <!-- LEFT SIDE -->
        <div class="col-md-5">

            {% if product.image %}
                <img src="{{ product.image.url }}" class="img-fluid rounded shadow mb-3">
            {% else %}
                <img src="https://via.placeholder.com/400x300?text=No+Image"
                     class="img-fluid rounded shadow mb-3">
            {% endif %}

            <h5 class="fw-semibold text-success">Description</h5>
            <p class="text-muted">{{ product.description }}</p>

        </div>

        <!-- RIGHT SIDE -->
        <div class="col-md-7">

            <h3 class="fw-bold text-success">{{ product.name }}</h3>

            <!-- AVERAGE STAR RATING -->
            <div class="mb-2">
                {% for i in "12345" %}
                    {% if forloop.counter <= average_rating %}
                        <i class="bi bi-star-fill text-warning"></i>
                    {% elif forloop.counter <= average_rating|add:"0.5" %}
                        <i class="bi bi-star-half text-warning"></i>
                    {% else %}
                        <i class="bi bi-star text-warning"></i>
                    {% endif %}
                {% endfor %}
                <span class="text-muted">({{ average_rating }}/5)</span>
            </div>

            <span class="badge bg-success">{{ product.category }}</span>

            {% if product.farmer %}
                <p class="mt-2 mb-1"><strong>Farmer:</strong> {{ product.farmer.username }}</p>
            {% endif %}

            <h4 class="fw-bold text-success mt-2">
                ₹ {{ product.discounted_price }}
            </h4>

            {% if product.discount_percent %}
                <p class="text-danger fw-semibold">
                    {{ product.discount_percent }}% OFF
                </p>
            {% endif %}

            <p class="mb-1"><strong>Stock:</strong> {{ product.stock }}</p>

            {% if product.weight %}
                <p class="mb-1"><strong>Weight:</strong> {{ product.weight }}</p>
            {% endif %}

            <!-- ADD TO CART + WISHLIST ROW -->
            {% if product.stock > 0 %}
            <form action="{% url 'add_to_cart' product.id %}" method="post" class="mt-3">
                {% csrf_token %}
                <div class="d-flex gap-2 align-items-center">

                

                    <!-- Add to Cart button (smaller width) -->
                    <button type="submit" class="btn btn-secondary" style="width:200px;">
                        <i class="bi bi-cart-plus"></i> Add to Cart
                    </button>

                    <!-- Wishlist button (heart) -->
                    <a href="{% url 'add_to_wishlist' product.id %}"
                       class="btn btn-outline-danger" style="width:50px;">
                        <i class="bi bi-heart"></i>
                    </a>

                </div>
            </form>

            
            {% else %}
            <p class="text-danger fw-bold mt-2">Out of Stock</p>
            {% endif %}

        </div>
    </div>

    <!-- REVIEWS -->
    <hr class="my-4">
    <h4 class="text-success fw-bold">
        <i class="bi bi-chat-dots"></i> Reviews
    </h4>

    {% for r in reviews %}
        <div class="p-3 mb-3 bg-white rounded shadow-sm">
            <strong>{{ r.customer.username }}</strong>

            <div>
                {% for i in "12345" %}
                    {% if forloop.counter <= r.rating %}
                        <i class="bi bi-star-fill text-warning"></i>
                    {% else %}
                        <i class="bi bi-star text-warning"></i>
                    {% endif %}
                {% endfor %}
            </div>

            <p class="mb-0">{{ r.comment }}</p>
        </div>
    {% empty %}
        <p class="text-muted">No reviews yet.</p>
    {% endfor %}

    <!-- Add space after reviews -->
    <div style="margin-top: 100px;"></div>

    <!-- ASK A QUESTION SECTION -->
<hr class="my-5">

<div class="card shadow-sm border-0">
    <div class="card-body">

        <h4 class="fw-bold text-success mb-3">
            <i class="bi bi-question-circle-fill"></i> Ask a Question
        </h4>

        <!-- Question Form -->
        <form method="post" class="mb-4">
            {% csrf_token %}

            <div class="mb-3">
                <textarea name="question"
                          rows="3"
                          class="form-control"
                          placeholder="Have a question about this product? Ask the farmer..."
                          required></textarea>
            </div>

            <button type="submit" class="btn btn-success px-4">
                <i class="bi bi-send"></i> Submit
            </button>
        </form>

        <!-- QUESTIONS LIST -->
        <h5 class="fw-semibold mb-3">Customer Questions</h5>

        {% for q in questions %}
            <div class="p-3 mb-3 rounded bg-light border">

                <!-- Question -->
                <div class="d-flex align-items-start gap-2">
                    <i class="bi bi-person-circle fs-4 text-secondary"></i>
                    <div>
                        <strong>{{ q.customer.username }}</strong>
                        <p class="mb-2">{{ q.question }}</p>
                    </div>
                </div>

                <!-- Answer -->
                {% if q.answer %}
                    <div class="mt-2 p-2 rounded bg-white border-start border-success border-3">
                        <small class="text-success fw-semibold">
                            <i class="bi bi-check-circle-fill"></i> Farmer Answer
                        </small>
                        <p class="mb-0">{{ q.answer }}</p>
                    </div>
                {% else %}
                    <p class="text-muted fst-italic mt-2 mb-0">
                        <i class="bi bi-hourglass-split"></i> Awaiting farmer response
                    </p>
                {% endif %}
            </div>
        {% empty %}
            <p class="text-muted">No questions yet. Be the first to ask!</p>
        {% endfor %}

    </div>
</div>
    <div style="margin-top: 100px;"></div>


    <!-- RELATED PRODUCTS -->
    <h4 class="text-success fw-bold">Related Products</h4>

    <div class="row">
        {% for rp in related_products %}
            <div class="col-md-3 mb-3">
                <div class="card h-100 shadow-sm">

                    {% if rp.image %}
                        <img src="{{ rp.image.url }}"
                             class="card-img-top"
                             style="height:150px; object-fit:cover;">
                    {% endif %}

                    <div class="card-body">
                        <h6 class="fw-semibold">{{ rp.name }}</h6>
                        <p class="text-success fw-bold">
                            ₹ {{ rp.discounted_price }}
                        </p>

                        <a href="{% url 'product_detail' rp.id %}"
                           class="btn btn-success btn-sm w-100">
                            View
                        </a>
                    </div>
                </div>
            </div>
        {% empty %}
            <p class="text-muted">No related products.</p>
        {% endfor %}
    </div>

</div>

{% endblock %}
